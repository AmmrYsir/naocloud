---
import BaseLayout from "../layouts/base-layout.astro";
import Navbar from "../components/layout/navbar.astro";
import Sidebar from "../components/layout/sidebar.astro";
import { getUserFromCookies } from "../lib/auth";
import { getUser } from "../lib/users";

const user = getUserFromCookies(Astro.cookies);
if (!user) return Astro.redirect("/login");

const dbUser = getUser(user.username);
---

<BaseLayout title="Profile â€“ ServerPilot">
	<Sidebar />
	<div class="flex flex-1 flex-col md:ml-64">
		<Navbar username={user.username} />

		<main class="flex-1 p-4 pb-16 md:p-6">
			<div class="mb-6">
				<h1 class="text-2xl font-bold tracking-tight">Profile</h1>
				<p class="mt-1 text-sm text-gray-500">
					Manage your account settings
				</p>
			</div>

			<div class="space-y-6 max-w-4xl">
				<!-- Profile Information -->
				<section>
					<h2 class="mb-4 text-lg font-semibold">Profile Information</h2>
					<div class="glass-card">
						<div class="flex flex-col sm:flex-row sm:items-center gap-4">
							<div class="flex h-16 w-16 items-center justify-center rounded-full bg-accent text-2xl font-bold text-white shrink-0">
								{user.username[0].toUpperCase()}
							</div>
							<div class="flex-1">
								<p class="text-lg font-semibold text-gray-200">{user.username}</p>
								<p class="text-sm capitalize text-gray-500">{user.role}</p>
							</div>
						</div>
						<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 mt-4 border-t border-border-dim">
							<div>
								<p class="text-xs text-gray-500">Created</p>
								<p class="text-sm text-gray-300">
									{dbUser?.createdAt ? new Date(dbUser.createdAt).toLocaleDateString() : "N/A"}
								</p>
							</div>
							<div>
								<p class="text-xs text-gray-500">Last Login</p>
								<p class="text-sm text-gray-300">
									{dbUser?.lastLogin ? new Date(dbUser.lastLogin).toLocaleDateString() : "N/A"}
								</p>
							</div>
						</div>
					</div>
				</section>

				<!-- Security -->
				<section>
					<h2 class="mb-4 text-lg font-semibold">Security</h2>
					<div class="glass-card space-y-6">
						<!-- Change Password -->
						<div>
							<h3 class="mb-3 text-sm font-medium text-gray-300">Change Password</h3>
							<div class="space-y-3">
								<input
									type="password"
									id="currentPassword"
									placeholder="Current password"
									class="w-full rounded-xl border border-border-dim bg-white/5 px-4 py-2.5 text-sm text-gray-200 placeholder-gray-600 outline-none transition focus:border-accent/50 focus:ring-1 focus:ring-accent/30"
								/>
								<input
									type="password"
									id="newPassword"
									placeholder="New password"
									class="w-full rounded-xl border border-border-dim bg-white/5 px-4 py-2.5 text-sm text-gray-200 placeholder-gray-600 outline-none transition focus:border-accent/50 focus:ring-1 focus:ring-accent/30"
								/>
								<input
									type="password"
									id="confirmPassword"
									placeholder="Confirm new password"
									class="w-full rounded-xl border border-border-dim bg-white/5 px-4 py-2.5 text-sm text-gray-200 placeholder-gray-600 outline-none transition focus:border-accent/50 focus:ring-1 focus:ring-accent/30"
								/>
							</div>
							<button
								id="btn-change-password"
								class="mt-3 rounded-xl bg-accent px-6 py-2.5 text-sm font-medium text-white transition hover:bg-accent/80"
							>
								Change Password
							</button>
						</div>

						<div class="border-t border-border-dim pt-6">
							<div class="flex items-center justify-between">
								<div>
									<h3 class="text-sm font-medium text-gray-300">Two-Factor Authentication</h3>
									<p class="text-xs text-gray-500">Add an extra layer of security to your account</p>
								</div>
								<span class="rounded-full bg-amber-500/20 px-2 py-0.5 text-xs font-medium text-amber-400">
									Coming Soon
								</span>
							</div>
							<button
								disabled
								class="mt-3 w-full rounded-xl border border-border-dim bg-white/5 px-6 py-2.5 text-sm font-medium text-gray-400 cursor-not-allowed opacity-50"
							>
								Enable 2FA
							</button>
						</div>
					</div>
				</section>

				<!-- Danger Zone -->
				<section>
					<h2 class="mb-4 text-lg font-semibold text-red-400">Danger Zone</h2>
					<div class="glass-card border-red-500/20">
						<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
							<div>
								<p class="text-sm font-medium text-gray-300">Delete Account</p>
								<p class="text-xs text-gray-500">Permanently delete your account and all data</p>
							</div>
							<button
								id="btn-delete-account"
								class="rounded-xl bg-red-500/10 px-5 py-2.5 text-sm font-medium text-red-400 transition hover:bg-red-500/20 shrink-0"
							>
								Delete Account
							</button>
						</div>
					</div>
				</section>
			</div>
		</main>
	</div>
</BaseLayout>

<!-- Delete Account Modal -->
<div id="delete-modal" class="fixed inset-0 z-50 hidden">
	<div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="modal-backdrop"></div>
	<div class="flex min-h-full items-center justify-center p-4">
		<div class="relative w-full max-w-md rounded-2xl border border-red-500/30 bg-[#1a1a2e] p-6 shadow-2xl">
			<div class="flex items-center gap-3 mb-4">
				<div class="flex h-10 w-10 items-center justify-center rounded-full bg-red-500/20">
					<svg class="h-5 w-5 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
					</svg>
				</div>
				<h3 class="text-lg font-semibold text-gray-200">Delete Account</h3>
			</div>
			<p class="text-sm text-gray-400 mb-4">
				This action is <span class="text-red-400 font-medium">permanent</span> and cannot be undone.
			</p>
			<p class="text-sm text-gray-400 mb-4">
				To confirm, type <span class="text-gray-200 font-mono bg-white/5 px-1.5 py-0.5 rounded">{user.username}</span> below:
			</p>
			<input
				type="text"
				id="confirm-username"
				placeholder="Type your username"
				class="w-full mb-4 rounded-xl border border-border-dim bg-white/5 px-4 py-2.5 text-sm text-gray-200 placeholder-gray-600 outline-none transition focus:border-red-500/50 focus:ring-1 focus:ring-red-500/30"
			/>
			<div class="flex gap-3">
				<button
					id="btn-cancel-delete"
					class="flex-1 rounded-xl border border-border-dim bg-white/5 px-4 py-2.5 text-sm font-medium text-gray-300 transition hover:bg-white/10"
				>
					Cancel
				</button>
				<button
					id="btn-confirm-delete"
					disabled
					class="flex-1 rounded-xl bg-red-500 px-4 py-2.5 text-sm font-medium text-white transition hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed"
				>
					Delete Account
				</button>
			</div>
			<p id="delete-error" class="text-xs text-red-400 mt-3 hidden"></p>
		</div>
	</div>
</div>

<script define:vars={{ username: user.username }}>
	// Password change
	const changePasswordBtn = document.getElementById("btn-change-password");

	changePasswordBtn?.addEventListener("click", async () => {
		const currentPassword = document.getElementById("currentPassword")?.value;
		const newPassword = document.getElementById("newPassword")?.value;
		const confirmPassword = document.getElementById("confirmPassword")?.value;

		if (!currentPassword || !newPassword || !confirmPassword) {
			alert("Please fill in all password fields");
			return;
		}

		if (newPassword !== confirmPassword) {
			alert("New passwords do not match");
			return;
		}

		if (newPassword.length < 6) {
			alert("Password must be at least 6 characters");
			return;
		}

		try {
			const res = await fetch("/api/modules/security/password", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ currentPassword, newPassword }),
			});

			if (res.ok) {
				alert("Password changed successfully");
				document.getElementById("currentPassword").value = "";
				document.getElementById("newPassword").value = "";
				document.getElementById("confirmPassword").value = "";
			} else {
				const data = await res.json();
				alert(data.error || "Failed to change password");
			}
		} catch {
			alert("An error occurred");
		}
	});

	// Delete account modal
	const deleteBtn = document.getElementById("btn-delete-account");
	const modal = document.getElementById("delete-modal");
	const modalBackdrop = document.getElementById("modal-backdrop");
	const cancelBtn = document.getElementById("btn-cancel-delete");
	const confirmBtn = document.getElementById("btn-confirm-delete");
	const confirmInput = document.getElementById("confirm-username");
	const deleteError = document.getElementById("delete-error");

	function openModal() {
		modal?.classList.remove("hidden");
		confirmInput?.focus();
	}

	function closeModal() {
		modal?.classList.add("hidden");
		if (confirmInput) confirmInput.value = "";
		if (confirmBtn) confirmBtn.setAttribute("disabled", "true");
		if (deleteError) deleteError.classList.add("hidden");
	}

	deleteBtn?.addEventListener("click", openModal);
	cancelBtn?.addEventListener("click", closeModal);
	modalBackdrop?.addEventListener("click", closeModal);

	confirmInput?.addEventListener("input", () => {
		if (confirmBtn) {
			confirmBtn.toggleAttribute("disabled", confirmInput.value !== username);
		}
	});

	confirmBtn?.addEventListener("click", async () => {
		if (confirmInput.value !== username) return;

		try {
			const res = await fetch("/api/modules/security/account", {
				method: "DELETE",
				headers: { "Content-Type": "application/json" },
			});

			const data = await res.json();

			if (res.ok) {
				alert("Account deleted successfully. You will be redirected.");
				window.location.href = "/login";
			} else {
				if (deleteError) {
					deleteError.textContent = data.error || "Failed to delete account";
					deleteError.classList.remove("hidden");
				}
			}
		} catch {
			if (deleteError) {
				deleteError.textContent = "An error occurred";
				deleteError.classList.remove("hidden");
			}
		}
	});

	// Close modal on escape
	document.addEventListener("keydown", (e) => {
		if (e.key === "Escape" && !modal?.classList.contains("hidden")) {
			closeModal();
		}
	});
</script>
