---
/**
 * [...slug].astro – Generic plugin page renderer.
 *
 * Dynamically discovers and renders plugin page components based on the
 * current route.  Plugins declare page components with a `route` field in
 * their manifest; this catch-all resolves the right component and loads it
 * via PluginComponentLoader, keeping all page metadata (title, description)
 * driven by the plugin manifest rather than hardcoded Astro pages.
 *
 * Because Astro matches static routes first, core pages (docker, settings,
 * system, etc.) are unaffected – only routes with no static page fall
 * through to this handler.
 */
import BaseLayout from "../layouts/BaseLayout.astro";
import Navbar from "../components/Navbar.astro";
import Sidebar from "../components/Sidebar.astro";
import PluginComponentLoader from "../components/PluginComponentLoader.jsx";
import { getUserFromCookies } from "../lib/auth";
import { getPluginComponentForRoute } from "../lib/plugins";

const user = getUserFromCookies(Astro.cookies);
if (!user) return Astro.redirect("/login");

// Build the route from the slug (e.g. ["logs"] → "/logs", ["a","b"] → "/a/b")
const slug = Astro.params.slug ?? "";
const route = `/${slug}`;

// Ask the plugin system which component (if any) owns this route
const pageComponent = getPluginComponentForRoute(route);

// If no plugin claims this route, return 404
if (!pageComponent) {
	return new Response(null, { status: 404, statusText: "Not Found" });
}

// Pull display metadata from the plugin manifest declaration
const pageTitle = pageComponent.title || pageComponent.pluginName;
const pageDescription = pageComponent.description || "";
---

<BaseLayout title={`${pageTitle} – ServerPilot`}>
	<Sidebar />
	<div class="flex flex-1 flex-col md:ml-64">
		<Navbar username={user.username} />

		<main class="flex-1 p-4 pb-20 md:p-6 md:pb-6">
			<div class="mb-6">
				<h1 class="text-2xl font-bold tracking-tight">{pageTitle}</h1>
				{pageDescription && (
					<p class="mt-1 text-sm text-gray-500">{pageDescription}</p>
				)}
			</div>

			<PluginComponentLoader
				client:load
				pluginId={pageComponent.pluginId}
				componentKey={pageComponent.key}
			/>
		</main>
	</div>
</BaseLayout>
