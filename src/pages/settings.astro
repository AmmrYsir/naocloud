---
import BaseLayout from "../layouts/base-layout.astro";
import Navbar from "../components/layout/navbar.astro";
import Sidebar from "../components/layout/sidebar.astro";
import { getUserFromCookies } from "../lib/auth";

const user = getUserFromCookies(Astro.cookies);
if (!user) return Astro.redirect("/login");
---

<BaseLayout title="Settings â€“ ServerPilot">
	<Sidebar />
	<div class="flex flex-1 flex-col md:ml-64">
		<Navbar username={user.username} />

		<main class="flex-1 p-4 pb-16 md:p-6">
			<div class="mb-6">
				<h1 class="text-2xl font-bold tracking-tight">Settings</h1>
				<p class="mt-1 text-sm text-gray-500">
					Manage your server configuration
				</p>
			</div>

			<div class="max-w-2xl">
				<!-- Backup & Export -->
				<section>
					<div class="glass-card">
						<div class="flex items-center gap-4 mb-6">
							<div class="flex h-12 w-12 items-center justify-center rounded-xl bg-blue-500/20 shrink-0">
								<svg class="h-6 w-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
								</svg>
							</div>
							<div>
								<h2 class="text-lg font-semibold text-gray-200">Backup & Export</h2>
								<p class="text-sm text-gray-500">Export or import your server configuration</p>
							</div>
						</div>

						<div class="space-y-4">
							<p class="text-sm text-gray-400">
								Export your current configuration as a JSON file or import a previously saved backup to restore your settings.
							</p>

							<div class="flex flex-col sm:flex-row gap-3 pt-2">
								<button
									id="btn-export"
									class="flex items-center justify-center gap-2 rounded-xl bg-blue-500/10 px-5 py-3 text-sm font-medium text-blue-400 transition hover:bg-blue-500/20"
								>
									<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
									</svg>
									Export Config
								</button>
								<label
									id="btn-import-label"
									class="cursor-pointer flex items-center justify-center gap-2 rounded-xl bg-emerald-500/10 px-5 py-3 text-sm font-medium text-emerald-400 transition hover:bg-emerald-500/20"
								>
									<svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
									</svg>
									Import Config
									<input
										type="file"
										id="import-file"
										accept=".json"
										class="hidden"
									/>
								</label>
							</div>

							<p id="import-status" class="text-sm hidden"></p>
						</div>
					</div>
				</section>
			</div>
		</main>
	</div>
</BaseLayout>

<script>
	const exportBtn = document.getElementById("btn-export");
	const importInput = document.getElementById("import-file");
	const importStatus = document.getElementById("import-status");

	exportBtn?.addEventListener("click", async () => {
		try {
			const res = await fetch("/api/settings/export");
			const data = await res.json();
			const blob = new Blob([JSON.stringify(data, null, 2)], {
				type: "application/json",
			});
			const url = URL.createObjectURL(blob);
			const a = document.createElement("a");
			a.href = url;
			a.download = `serverpilot-config-${new Date().toISOString().slice(0, 10)}.json`;
			a.click();
			URL.revokeObjectURL(url);

			if (importStatus) {
				importStatus.textContent = "Config exported successfully!";
				importStatus.className = "text-sm text-emerald-400 mt-3";
				importStatus.classList.remove("hidden");
				setTimeout(() => importStatus.classList.add("hidden"), 3000);
			}
		} catch {
			if (importStatus) {
				importStatus.textContent = "Failed to export config";
				importStatus.className = "text-sm text-red-400 mt-3";
				importStatus.classList.remove("hidden");
			}
		}
	});

	importInput?.addEventListener("change", async (e) => {
		const file = (e.target as HTMLInputElement).files?.[0];
		if (!file) return;

		const text = await file.text();
		try {
			const data = JSON.parse(text);
			const res = await fetch("/api/settings/import", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(data),
			});

			if (res.ok) {
				if (importStatus) {
					importStatus.textContent = "Config imported successfully!";
					importStatus.className = "text-sm text-emerald-400 mt-3";
					importStatus.classList.remove("hidden");
					setTimeout(() => importStatus.classList.add("hidden"), 3000);
				}
			} else {
				const err = await res.json();
				if (importStatus) {
					importStatus.textContent = err.error || "Import failed";
					importStatus.className = "text-sm text-red-400 mt-3";
					importStatus.classList.remove("hidden");
				}
			}
		} catch {
			if (importStatus) {
				importStatus.textContent = "Invalid JSON file";
				importStatus.className = "text-sm text-red-400 mt-3";
				importStatus.classList.remove("hidden");
			}
		}

		// Reset file input
		(e.target as HTMLInputElement).value = "";
	});
</script>
