---
/**
 * Navbar.astro â€“ Top navigation bar with branding, theme toggle, and user controls.
 */
interface Props {
	username?: string;
}
const { username = "admin" } = Astro.props;
---

<nav
	class="glass-card !rounded-none sticky top-0 z-50 flex items-center justify-between border-b border-border-dim px-4 py-3 md:px-6 !bg-panel/80 backdrop-blur-xl"
>
	<!-- Left: Hamburger (mobile) + Logo -->
	<div class="flex items-center gap-3">
		<!-- Hamburger Menu (mobile only) -->
		<button
			id="hamburger-btn"
			class="md:hidden flex h-9 w-9 items-center justify-center rounded-xl text-gray-400 transition hover:bg-white/10"
			aria-label="Open menu"
		>
			<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
				<path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
			</svg>
		</button>

		<!-- Logo / Brand -->
		<div class="flex items-center gap-3">
			<div
				class="flex h-9 w-9 items-center justify-center rounded-xl bg-accent text-white font-bold text-sm"
			>
				SP
			</div>
			<span class="hidden text-lg font-semibold tracking-tight sm:inline"
				>ServerPilot</span
			>
		</div>
	</div>

	<!-- Right controls -->
	<div class="flex items-center gap-3">
		<!-- Theme toggle -->
		<button
			id="theme-toggle"
			class="flex h-9 w-9 items-center justify-center rounded-xl text-gray-400 transition hover:bg-gray-500/10 hover:text-gray-600 dark-hover:text-white"
			aria-label="Toggle theme"
		>
			<!-- Sun icon (shown in dark mode) -->
			<svg
				id="icon-sun"
				class="h-5 w-5"
				fill="none"
				viewBox="0 0 24 24"
				stroke="currentColor"
				stroke-width="2"
			>
				<circle cx="12" cy="12" r="5"></circle><path
					d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
				></path>
			</svg>
			<!-- Moon icon (shown in light mode) -->
			<svg
				id="icon-moon"
				class="hidden h-5 w-5"
				fill="none"
				viewBox="0 0 24 24"
				stroke="currentColor"
				stroke-width="2"
			>
				<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
				></path>
			</svg>
		</button>

		<!-- User badge -->
		<div
			class="flex items-center gap-2 rounded-xl bg-white/5 px-3 py-1.5 text-sm"
		>
			<div
				class="h-6 w-6 rounded-full bg-accent/30 flex items-center justify-center text-xs font-bold text-accent"
			>
				{username[0].toUpperCase()}
			</div>
			<span class="hidden sm:inline">{username}</span>
		</div>

		<!-- Logout -->
		<form
			method="POST"
			action="/api/auth/logout"
			id="logout-form"
			style="display:contents;"
		>
			<button
				type="submit"
				class="flex h-9 w-9 items-center justify-center rounded-xl text-gray-400 transition hover:bg-red-500/10 hover:text-red-500"
				aria-label="Logout"
			>
				<svg
					class="h-5 w-5"
					fill="none"
					viewBox="0 0 24 24"
					stroke="currentColor"
					stroke-width="2"
				>
					<path
						d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14 5-5-5-5m5 5H9"
					></path>
				</svg>
			</button>
		</form>
	</div>
</nav>

<!-- Mobile Menu Overlay -->
<div
	id="mobile-menu"
	class="fixed inset-0 z-[60] hidden"
>
	<!-- Backdrop -->
	<div id="mobile-menu-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

	<!-- Drawer -->
	<div id="mobile-menu-drawer" class="absolute left-0 top-0 bottom-0 w-72 max-w-[85vw] bg-panel border-r border-border-dim transform -translate-x-full transition-transform duration-300">
		<div class="flex flex-col h-full">
			<!-- Header -->
			<div class="flex items-center justify-between border-b border-border-dim p-4">
				<div class="flex items-center gap-3">
					<div class="flex h-9 w-9 items-center justify-center rounded-lg bg-accent">
						<svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
							<path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
						</svg>
					</div>
					<span class="text-lg font-bold text-gray-100">ServerPilot</span>
				</div>
				<button id="mobile-menu-close" class="h-9 w-9 flex items-center justify-center rounded-xl text-gray-400 hover:bg-white/10">
					<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>

			<!-- Navigation Links -->
			<nav class="flex-1 overflow-y-auto p-4 space-y-1">
				<a href="/" class="mobile-nav-item flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-gray-400 transition hover:bg-white/5 hover:text-gray-200">
					<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/>
					</svg>
					Dashboard
				</a>
				<a href="/docker" class="mobile-nav-item flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-gray-400 transition hover:bg-white/5 hover:text-gray-200">
					<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<path d="M21 8c-1.45 0-2.26.15-3 .5-1.12-1.28-2.7-2-4.5-2h-3c-1.8 0-3.38.72-4.5 2C5.26 8.15 4.45 8 3 8c-1 0-1 2 0 2 .6 0 1 .1 1.4.3C4.15 11.4 4 12.6 4 14c0 3.32 2.68 6 6 6h4c3.32 0 6-2.68 6-6 0-1.4-.15-2.6-.4-3.7.4-.2.8-.3 1.4-.3 1 0 1-2 0-2z"/>
					</svg>
					Docker
				</a>
				<a href="/services" class="mobile-nav-item flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-gray-400 transition hover:bg-white/5 hover:text-gray-200">
					<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<path d="M4 6h16M4 12h16M4 18h16"/>
					</svg>
					Services
				</a>
				<a href="/system" class="mobile-nav-item flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-gray-400 transition hover:bg-white/5 hover:text-gray-200">
					<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8m-4-4v4"/>
					</svg>
					System
				</a>

				<div class="my-4 border-t border-border-dim"></div>

				<a href="/settings" class="mobile-nav-item flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-gray-400 transition hover:bg-white/5 hover:text-gray-200">
					<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
						<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
					</svg>
					Settings
				</a>
				<a href="/profile" class="mobile-nav-item flex items-center gap-3 rounded-xl px-4 py-3 text-sm font-medium text-gray-400 transition hover:bg-white/5 hover:text-gray-200">
					<svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
						<path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
					</svg>
					Profile
				</a>
			</nav>

			<!-- User info at bottom -->
			<div class="border-t border-border-dim p-4">
				<div class="flex items-center gap-3">
					<div class="flex h-10 w-10 items-center justify-center rounded-full bg-accent text-sm font-bold text-white">
						{username[0].toUpperCase()}
					</div>
					<div class="flex-1 overflow-hidden">
						<p class="truncate text-sm font-medium text-gray-200">{username}</p>
						<p class="truncate text-xs text-gray-500">Account</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	const hamburgerBtn = document.getElementById("hamburger-btn");
	const mobileMenu = document.getElementById("mobile-menu");
	const mobileMenuBackdrop = document.getElementById("mobile-menu-backdrop");
	const mobileMenuClose = document.getElementById("mobile-menu-close");
	const mobileMenuDrawer = document.getElementById("mobile-menu-drawer");

	function openMobileMenu() {
		mobileMenu?.classList.remove("hidden");
		mobileMenuDrawer?.classList.remove("-translate-x-full");
		document.body.style.overflow = "hidden";
	}

	function closeMobileMenu() {
		mobileMenuDrawer?.classList.add("-translate-x-full");
		setTimeout(() => {
			mobileMenu?.classList.add("hidden");
		}, 300);
		document.body.style.overflow = "";
	}

	hamburgerBtn?.addEventListener("click", openMobileMenu);
	mobileMenuBackdrop?.addEventListener("click", closeMobileMenu);
	mobileMenuClose?.addEventListener("click", closeMobileMenu);

	// Close on escape
	document.addEventListener("keydown", (e) => {
		if (e.key === "Escape" && !mobileMenu?.classList.contains("hidden")) {
			closeMobileMenu();
		}
	});

	// Close when clicking nav links
	document.querySelectorAll(".mobile-nav-item").forEach((link) => {
		link.addEventListener("click", closeMobileMenu);
	});

	// Theme toggle logic
	const themeBtn = document.getElementById("theme-toggle");
	const iconSun = document.getElementById("icon-sun");
	const iconMoon = document.getElementById("icon-moon");

	function applyThemeIcons() {
		const isLight = document.body.classList.contains("light");
		iconSun?.classList.toggle("hidden", isLight);
		iconMoon?.classList.toggle("hidden", !isLight);
	}

	applyThemeIcons();

	themeBtn?.addEventListener("click", () => {
		document.body.classList.toggle("light");
		const isLight = document.body.classList.contains("light");
		localStorage.setItem("sp-theme", isLight ? "light" : "dark");
		applyThemeIcons();
	});

	// Handle logout form via fetch + redirect
	const logoutForm = document.getElementById("logout-form") as HTMLFormElement;
	logoutForm?.addEventListener("submit", async (e) => {
		e.preventDefault();
		await fetch("/api/auth/logout", { method: "POST" });
		window.location.href = "/login";
	});
</script>
